<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
</head>
<body>
    <h1>Student Dashboard</h1>
    <div id="studentInfo"></div>
    <button onclick="window.location.href='index.html'">Logout</button>

    <div>
        <h2>Admin Posts</h2>
        <button onclick="loadData()">Refresh</button>
        <div id="adminPosts"></div>
    </div>

    <div>
        <h2>Faculty Posts</h2>
        <div id="facultyPosts"></div>
    </div>

    <script>
        const API_BASE = `${window.location.origin}/api`;
        let studentCode = '';
        let studentClass = '';
        let studentRoll = '';

        function initializeStudent() {
            studentCode = sessionStorage.getItem('studentCode') || '';
            if (!studentCode) {
                window.location.href = 'index.html';
                return false;
            }

            // Extract class and roll from student code (222p-1a-10 -> class: 1a, roll: 10)
            const match = studentCode.match(/222p-(\d+[a-z])-(\d+)/i);
            if (match) {
                studentClass = match[1].toLowerCase();
                studentRoll = match[2];
            }

            document.getElementById('studentInfo').innerHTML = 
                `<h2>Welcome Student - Class ${studentClass.toUpperCase()}, Roll No: ${studentRoll}</h2>`;
            
            return true;
        }

        async function loadData() {
            try {
                const response = await fetch(`${API_BASE}/data`);
                const data = await response.json();
                displayAdminPosts(data);
                displayFacultyPosts(data);
            } catch (error) {
                document.getElementById('adminPosts').innerHTML = 
                    '<p>Error loading data. Make sure the server is running.</p>';
            }
        }

        function displayAdminPosts(data) {
            let html = '';
            
            html += '<h3>Holidays</h3>';
            if (data.holidays.length > 0) {
                data.holidays.forEach(post => {
                    html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                });
            } else {
                html += '<p>No holidays posted</p>';
            }

            html += '<h3>Payment Dues</h3>';
            if (data.paymentDues[studentClass] && data.paymentDues[studentClass].length > 0) {
                data.paymentDues[studentClass].forEach(post => {
                    html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                });
            } else {
                html += '<p>No payment dues for your class</p>';
            }

            html += '<h3>Key Information</h3>';
            if (data.keyInfo.length > 0) {
                data.keyInfo.forEach(post => {
                    html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                });
            } else {
                html += '<p>No key information posted</p>';
            }

            document.getElementById('adminPosts').innerHTML = html;
        }

        function displayFacultyPosts(data) {
            let html = '';
            
            if (data.facultyPosts[studentClass]) {
                const posts = data.facultyPosts[studentClass];
                
                html += '<h3>Homework</h3>';
                if (posts.homework && posts.homework.length > 0) {
                    posts.homework.forEach(post => {
                        html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                    });
                } else {
                    html += '<p>No homework posted</p>';
                }

                html += '<h3>Online Assignments</h3>';
                if (posts.assignment && posts.assignment.length > 0) {
                    posts.assignment.forEach(post => {
                        html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                    });
                } else {
                    html += '<p>No assignments posted</p>';
                }

                html += '<h3>Subject Information</h3>';
                if (posts.subject && posts.subject.length > 0) {
                    posts.subject.forEach(post => {
                        html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                    });
                } else {
                    html += '<p>No subject information posted</p>';
                }
            } else {
                html = '<p>No faculty posts for your class yet</p>';
            }

            document.getElementById('facultyPosts').innerHTML = html;
        }

        window.onload = function() {
            if (initializeStudent()) {
                loadData();
            }
        };
    </script>
</body>
</html>