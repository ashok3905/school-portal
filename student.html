<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
</head>
<body>
    <h1>Student Dashboard</h1>
    <div id="studentInfo"></div>
    <button onclick="window.location.href='index.html'">Logout</button>
    <button onclick="loadData()">Refresh All Data</button>

    <div>
        <h2>Admin Posts</h2>
        <div id="adminPosts"></div>
    </div>

    <div>
        <h2>Faculty Posts for Your Class</h2>
        <div id="facultyPosts"></div>
    </div>

    <script>
        const API_BASE = `${window.location.origin}/api`;
        let studentCode = '';
        let studentClass = '';
        let studentRoll = '';

        function initializeStudent() {
            studentCode = sessionStorage.getItem('studentCode') || '';
            if (!studentCode) {
                alert('Please login first');
                window.location.href = 'index.html';
                return false;
            }

            // Extract class and roll from student code (222p-1a-10 -> class: 1a, roll: 10)
            const match = studentCode.match(/222p-(\d+[a-z])-(\d+)/i);
            if (match) {
                studentClass = match[1].toLowerCase();
                studentRoll = match[2];
            } else {
                alert('Invalid student code format');
                window.location.href = 'index.html';
                return false;
            }

            document.getElementById('studentInfo').innerHTML = 
                `<h3>Welcome Student - Class ${studentClass.toUpperCase()}, Roll No: ${studentRoll}</h3>`;
            
            return true;
        }

        async function loadData() {
            try {
                console.log('Loading data for student class:', studentClass);
                const response = await fetch(`${API_BASE}/data`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                
                displayAdminPosts(data);
                displayFacultyPosts(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('adminPosts').innerHTML = 
                    '<p>Error loading data. Make sure the server is running.</p>';
                document.getElementById('facultyPosts').innerHTML = 
                    '<p>Error loading faculty posts.</p>';
            }
        }

        function displayAdminPosts(data) {
            let html = '';
            
            // Holidays section
            html += '<h3>Holidays</h3>';
            if (data.holidays && data.holidays.length > 0) {
                data.holidays.slice().reverse().forEach(post => {
                    html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                });
            } else {
                html += '<p>No holidays announced yet</p>';
            }

            // Payment dues section
            html += '<h3>Payment Dues for Your Class</h3>';
            if (data.paymentDues && data.paymentDues[studentClass] && data.paymentDues[studentClass].length > 0) {
                data.paymentDues[studentClass].slice().reverse().forEach(post => {
                    html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                });
            } else {
                html += '<p>No payment dues for your class</p>';
            }

            // Key information section
            html += '<h3>Important Information</h3>';
            if (data.keyInfo && data.keyInfo.length > 0) {
                data.keyInfo.slice().reverse().forEach(post => {
                    html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                });
            } else {
                html += '<p>No important information posted yet</p>';
            }

            document.getElementById('adminPosts').innerHTML = html;
        }

        function displayFacultyPosts(data) {
            let html = '';
            
            if (data.facultyPosts && data.facultyPosts[studentClass]) {
                const posts = data.facultyPosts[studentClass];
                
                // Homework section
                html += '<h3>Homework</h3>';
                if (posts.homework && posts.homework.length > 0) {
                    posts.homework.slice().reverse().forEach(post => {
                        html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                    });
                } else {
                    html += '<p>No homework assigned yet</p>';
                }

                // Assignments section
                html += '<h3>Online Assignments</h3>';
                if (posts.assignment && posts.assignment.length > 0) {
                    posts.assignment.slice().reverse().forEach(post => {
                        html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                    });
                } else {
                    html += '<p>No online assignments posted yet</p>';
                }

                // Subject information section
                html += '<h3>Subject Information</h3>';
                if (posts.subject && posts.subject.length > 0) {
                    posts.subject.slice().reverse().forEach(post => {
                        html += `<p><strong>${post.date}:</strong> ${post.text}</p>`;
                    });
                } else {
                    html += '<p>No subject information posted yet</p>';
                }
            } else {
                html = '<p>No faculty posts for your class yet</p>';
            }

            document.getElementById('facultyPosts').innerHTML = html;
        }

        window.onload = function() {
            if (initializeStudent()) {
                loadData();
            }
        };
    </script>
</body>
</html>